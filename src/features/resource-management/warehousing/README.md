# 倉儲管理模組 v3.0 - 設計藍圖

本文件詳細闡述了 Beta-db 整合平台中「倉儲管理」功能的完整系統設計、資料庫結構與前端架構。此模組是一個以「單一作業中心」為核心的高度整合介面。

## 1. 核心設計理念 (Core Philosophy)

取代傳統的多頁面切換模式，新的倉儲管理模組遵循「情境式操作」和「一個元件只做一件事」的原則：

- **單一作業中心**: 所有核心的倉儲操作——從查看庫存、管理倉庫、新增物料到追蹤歷史紀錄——都在同一個介面中完成，無需頁面跳轉。
- **庫存為核心**: 系統以「庫存水平」作為核心視圖，所有其他功能都圍繞著「庫存」這個中心概念展開。
- **元件職責單一**: 每個 React 元件都有一個明確、獨立的功能，確保了程式碼的高度可維護性。
- **智慧化流程**: 系統會根據使用者當前所在的視圖（例如：正在查看「台北倉」），自動調整操作的預設行為（例如：新增的物料會自動歸屬到「台北倉」），簡化了操作流程。

## 2. 資料庫設計 (Supabase / PostgreSQL)

為實現結構化數據的完整性和複雜查詢的能力，整個倉儲管理模組的資料將儲存在 Supabase (PostgreSQL) 中。

### 資料表 1: `warehouses` (倉庫主檔)

定義所有實體的倉庫或庫存地點。

| 欄位        | 類型      | 描述                       |
| :---------- | :-------- | :------------------------- |
| `id`        | `uuid`    | 主鍵，自動生成。           |
| `name`      | `text`    | 倉庫的唯一名稱。           |
| `location`  | `text`    | (可選) 倉庫的地址。        |
| `is_active` | `boolean` | 標記此倉庫是否仍在運作中。 |

### 資料表 2: `inventory_categories` (物料分類)

定義物料的分類。

| 欄位   | 類型   | 描述             |
| :----- | :----- | :--------------- |
| `id`   | `uuid` | 主鍵。           |
| `name` | `text` | 分類的唯一名稱。 |

### 資料表 3: `inventory_items` (物料主檔)

物料的**主檔目錄**，定義了所有物料的基礎資訊，但不包含庫存數量。

| 欄位                   | 類型      | 描述                                                |
| :--------------------- | :-------- | :-------------------------------------------------- |
| `id`                   | `uuid`    | 主鍵。                                              |
| `name`                 | `text`    | 物料/工具的名稱。                                   |
| `category`             | `text`    | (可選) 物料分類。                                   |
| `unit`                 | `text`    | (可選) 計量單位。                                   |
| `safe_stock_level`     | `integer` | (可選) 安全庫存水位。                               |
| `item_type`            | `text`    | 核心身份：'asset' (資產) 或 'consumable' (消耗品)。 |
| `has_expiry_tracking`  | `boolean` | 是否需效期管理。                                    |
| `requires_maintenance` | `boolean` | 是否需定期維護。                                    |
| `requires_inspection`  | `boolean` | 是否需定期檢驗。                                    |
| `is_serialized`        | `boolean` | 是否需序號管理。                                    |

### 資料表 4: `inventory_levels` (庫存水平)

**核心庫存資料表**。每一行代表「一個特定物料在一個特定倉庫的庫存數量」。

- **複合唯一鍵**: (`item_id`, `warehouse_id`)

| 欄位           | 類型      | 描述                                  |
| :------------- | :-------- | :------------------------------------ |
| `id`           | `uuid`    | 主鍵。                                |
| `item_id`      | `uuid`    | **[外鍵]** 關聯到 `inventory_items`。 |
| `warehouse_id` | `uuid`    | **[外鍵]** 關聯到 `warehouses`。      |
| `quantity`     | `integer` | **核心**。當前的實際庫存數量。        |

### 資料表 5: `inventory_movements` (庫存移動紀錄)

作為不可變的流水帳，記錄每一次庫存的變動歷史。

| 欄位           | 類型          | 描述                                        |
| :------------- | :------------ | :------------------------------------------ |
| `id`           | `uuid`        | 主鍵。                                      |
| `item_id`      | `uuid`        | **[外鍵]** 關聯到 `inventory_items`。       |
| `warehouse_id` | `uuid`        | **[外鍵]** 關聯到 `warehouses`。            |
| `type`         | `text`        | 變動類型: 'inbound', 'outbound', 'adjust'。 |
| `quantity`     | `integer`     | 變動的數量（出庫為負，入庫為正）。          |
| `project_id`   | `text`        | (可選) 關聯到的專案 ID。                    |
| `operator_id`  | `text`        | (可選) 操作人員的 `users` ID。              |
| `timestamp`    | `timestamptz` | 變動發生的時間。                            |

## 3. 前端架構與元件職責

所有功能都圍繞單一頁面 `src/app/(dashboard)/resource-management/warehousing/page.tsx` 展開，該頁面負責獲取所有初始數據並傳遞給主視圖元件。

### 📁 `views/` - 構成主要 UI 區塊的大型視圖元件

- **`warehousing-view.tsx`**:
  - **職責**: 整個模組的根元件和狀態協調中心。
  - **功能**:
    - 接收從 `page.tsx` 傳來的全部初始數據。
    - 管理所有表單對話方塊（新增倉庫、物料、分類）的開啟/關閉狀態。
    - 將數據和操作函數傳遞給子元件 `WarehouseSelector` 和 `StockLevelTable`。

- **`movement-list-view.tsx`**:
  - **職責**: 以**對話方塊**形式，顯示**特定物料**的出入庫歷史紀錄。
  - **功能**:
    - 接收一個 `itemId` 作為篩選條件。
    - 顯示一個清晰、可搜尋的歷史紀錄表格。

### 📁 `components/` - 小型的、可在模組內多處重用的元件

- **`warehouse-selector.tsx`**:
  - **職責**: 專門負責顯示倉庫列表，並允許使用者選擇一個倉庫來篩選庫存。
  - **功能**:
    - 將「新增倉庫」按鈕整合在列表底部。
    - 直接顯示每個倉庫的狀態（啟用/停用、租約狀態）。
    - 透過更新 URL search param (`warehouseId`) 來觸發主視圖的數據重新篩選。

### 📁 `tables/` - 核心的庫存水平表格元件

- **`stock-level-table.tsx`**:
  - **職責**: 模組的核心，顯示物料的庫存水平。
  - **功能**:
    - 根據 `warehouseId` 篩選並顯示對應的物料庫存。
    - 在「所有倉庫」視圖下，提供可展開的行來顯示各倉庫分佈。
    - 將「新增物料」和「新增類別」按鈕整合在表格標頭。
    - 在每一行提供情境式操作按鈕（出庫、入庫、查看歷史紀錄）。

### 📁 `forms/` - 用於新增/編輯的獨立表單對話方塊

每個表單都是一個獨立的、職責單一的元件。

- **`warehouse-form.tsx`**: 新增或編輯「倉庫」。
- **`item-form.tsx`**: 新增或編輯「物料主檔」。
- **`category-form.tsx`**: 新增或編輯「物料分類」。
- **`movement-form.tsx`**: (規劃中) 處理單筆出入庫或庫存調整操作。

### 📁 `actions/` - Server Actions

- **`warehousing-actions.ts`**: 處理所有與倉儲相關的後端業務邏輯，包括與 Supabase 資料庫的所有互動。這是唯一與資料庫溝通的途徑。

### 📁 `utils/` - 工具函數

- **`data-mappers.ts`**: 包含將從 Supabase 獲取的 `snake_case` 格式數據，轉換為前端使用的 `camelCase` TypeScript 類型的所有函數。
