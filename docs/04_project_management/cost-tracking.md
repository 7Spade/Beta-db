# 「成本與預算」監控系統 - 設計藍圖

本文件旨在詳細闡述 Beta-db 整合平台中，如何整合各模組數據，建立一個即時、動態的成本與預算監控系統。

## 1. 核心目標 (Core Objectives)

此系統的核心目標是將分散在不同模組中的「財務預算」與「實際成本」數據進行關聯和對比，從而：
- **提升透明度**: 讓專案經理和決策者能夠即時了解專案的財務健康狀況。
- **提供預警**: 在成本超支或進度落後時，及時向相關人員發出警示。
- **數據驅動決策**: 提供準確的數據分析，幫助管理者從「憑經驗」轉向「靠數據」來管理專案。
- **數據閉環**: 將工程數據（進度、資源消耗）與財務數據（預算、計價）真正打通，形成完整的數據閉環。

## 2. 功能規劃 (Feature Breakdown)

### 階段一：成本預算追蹤 (Cost vs. Budget Tracking)
- **位置**: 「專案詳情」頁面新增一個「成本分析」標籤頁。
- **數據來源**:
    - **預算 (Budget)**: `projects` 集合中，每個任務的 `value` 欄位（工料清單的預算價值）。
    - **實際成本 (Actual Cost)**:
        - **人力成本**: 來自「工地日報」中記錄的 `manpower` 工時，乘以 `teamMembers` 中對應成員的時薪（需為 `teamMembers` 新增 `hourlyRate` 欄位）。
        - **材料成本**: 來自「庫存系統」中，與該專案關聯的物料 `outbound`（出庫）記錄的總價值。
- **功能**:
    - 以視覺化圖表（如長條圖）展示專案總預算、總實際成本，以及各主要任務的預算與成本對比。
    - 明確標示出成本差異（Cost Variance），當實際成本超過預算時以紅色警示。
- **效益**: 提供最直觀的成本健康度檢查。

### 階段二：進度差異分析 (Schedule Variance Analysis)
- **位置**: 「成本分析」標籤頁內。
- **功能**:
    - **數據來源**:
        - **計畫進度**: `projects` 中各任務的預計開始/結束日期。
        - **實際進度**: 「工地日報」或「進度回報」功能中記錄的每日完成項目。
    - **S-Curve 生成**: 系統根據上述數據，自動繪製簡易的計畫 vs. 實際的進度 S 曲線圖。
    - **視覺化呈現**: S 曲線能直觀地展示出專案目前是**提前 (Ahead of Schedule)**、**落後 (Behind Schedule)** 還是**按計畫進行 (On Schedule)**。
- **效益**: 從時間維度評估專案績效，讓管理者能快速識別進度風險。

### 階段三：智慧警示與預測 (AI-Powered Alerts & Forecasting)
- **目標**: 從被動查詢進化到主動提醒。
- **功能**:
    - **低利潤警示**: 當系統偵測到某個任務的「實際成本」佔「預算價值」的比例超過一個預設閾值（例如 85%）時，自動在儀表板或透過通知向專案經理發出警示。
    - **完工成本預測 (EAC - Estimate at Completion)**:
        - 引入一個新的 AI 流程。
        - 該流程會基於目前的成本績效指標 (CPI - Cost Performance Index) 和進度績效指標 (SPI - Schedule Performance Index)，預測專案最終可能的總花費。
        - 例如，如果一個任務已經花費了 60% 的預算但只完成了 50% 的工作，AI 會預測該任務最終將會超支。
- **效益**: 將數據分析的能力賦予系統，讓平台能主動幫助使用者發現潛在問題。

## 3. 資料庫設計影響 (Database Design Impact)

為實現此系統，需要對現有資料庫結構進行少量擴展：

- **`teamMembers` 集合**:
  - 新增欄位 `hourlyRate` (`number`)，用於計算人力成本。

- **`inventory_movements` 集合 (來自庫存系統藍圖)**:
  - 確保出庫記錄 (`type: 'outbound'`) 中包含 `projectId` 和 `taskId`，以便將材料消耗歸屬到具體的專案和任務。

## 4. 前端架構影響 (Frontend Architecture Impact)

- 需要在「專案詳情」頁面新增一個「成本分析」的標籤頁。
- 需要引入更多的圖表元件（如 `recharts`）來繪製成本對比圖和 S 曲線。
- 需要開發新的 AI 流程用於成本預測。

### 結構樹 (Structure Tree)
```
src/
├── app/
│   └── (dashboard)/
│       └── projects/
│           └── [id]/
│               └── (tabs)/
│                   ├── cost-analysis/      <-- 新路由
│                   │   └── page.tsx
│                   └── layout.tsx            <-- 修改現有佈局以包含新標籤頁
├── components/
│   └── features/
│       └── projects/
│           ├── cost-analysis/              <-- 新目錄
│           │   ├── cost-analysis-view.tsx  # 主視圖，包含所有圖表和統計
│           │   ├── budget-vs-actual-chart.tsx
│           │   └── s-curve-chart.tsx
│           └── actions/
│               └── cost-actions.ts         # 用於獲取成本數據的 Server Actions
└── ai/
    └── flows/
        └── predict-project-cost-flow.ts    <-- 新 AI 流程

```

---
**結論**: 此監控系統是實現平台「數據驅動」核心價值的關鍵。它將前端收集的零散數據轉化為有意義的、可指導行動的商業洞察，是提升平台對高階管理者吸引力的重要功能。
